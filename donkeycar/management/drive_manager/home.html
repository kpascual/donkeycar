{% extends "base.html" %}

{% block content %}

<div class="container-fluid">

    <h1>Donkey Car Drive Manager</h1>

    <div class='row'>
        <div class='col-md-6'>
            <h2>1. Car Setup</h2>
            <div class='row'>
                <div class='col-md-6'>
                    <h3>1a. Parts</h3>
                    {% for config in carconfigs %}
                        <input name='config' id='config-{{config}}' type='radio' value='{{config}}'><label for='config-{{config}}'>{{config}}</label><br />
                    {% end %}
                </div>
                <div class='col-md-6'>
                    <h3>1b. AI Driver</h3>
                    <input name='driver' id='driver-manual' type='radio' value='manual' checked><label for='driver-manual'>None (default)</label><br />
                    {% for driver in drivers %}
                        <input name='driver' id='driver-{{driver}}' type='radio' value='{{driver}}'><label for='driver-{{driver}}'>{{driver}}</label><br />
                    {% end %}
                </div>
            </div>

            <p>
                <button id='configure-parts' class='btn btn-secondary'>Instantiate Vehicle</button>
            </p>

            <h2>2. Data Recording Configuration</h2>
            <h3>Drive Session Name (path to save data)</h3>
            <input id='custom-telemetry-path' type='checkbox'>
            Record to: <input id='telemetry-path' disabled>Path here</input><br />


            <h3>Data Channels to Record</h3>
            <div id='data-channels'></div>

            <p>
                <button id='configure-recorder' class='btn btn-secondary'>Set Data Recording Configuration</button>
            </p>




        </div>
        <div class='col-md-6'>
            <div id='drive-controls'>
                <button id='toggle-drive' class='btn btn-primary btn-large btn-block' >Start Car</button>
            </div>
            <h3>Current Configuration</h3>
            <pre id='parts'><code></code>
            </pre>
        </div>
    </div>




    Throttle constrain?<br />
</div>

<script type='text/javascript'>
    let config;
    var parts;
    var dataChannels;

    //let observer = new Proxy();
    $(document).ready(function() {
        $("#toggle-drive").click(function() {
            let val = $(this).text();
            let that = this;
            if (val == "Start Car") {
                // start drive
                $.ajax({
                    type: "POST",
                    url: "drive", 
                    data: {
                        "command": "start",
                        "config": $('input[name="config"]:checked').val(),
                        "driver": $('input[name="driver"]:checked').val()
                    },
                    success: function(data) {
                        console.log(data);
                        $(that).text("Stop");
                    } 
                });
            } else {
                // stop drive
                $.ajax({
                    type: "POST",
                    url: "drive", 
                    data: {"command": "stop"},
                    success: function(data) {
                        console.log(data);
                        $(that).text("Start Car"); 
                    }
                });
            }
        });
        $("#custom-telemetry-path").change(function(){
            if ($(this).prop('checked')) {
                $("#telemetry-path").prop('disabled', false);
            } else {
                $("#telemetry-path").prop('disabled', true);
            }
        });


        $("#configure-parts").click(function(){
            let config = $('input[name="config"]:checked').val();
            let driver = $('input[name="driver"]:checked').val();
            let path = null;

            if ($("#custom-telemetry-path").prop('checked')) {
                path = $("#telemetry-path").val();
            }            
            $.ajax({
                type: "POST",
                url: "car_config", 
                data: {
                    "config": config,
                    "path": path,
                    "driver": driver
                },
                success: function(data) {
                    $("#parts code").text(JSON.stringify(data['parts'], undefined, 2));
                    channels = data['channels'];

                    //$("#data-channels").text(JSON.stringify(dataChannels));
                    divDataChannels = $('#data-channels');
                    channels.forEach(function(channel) {
                        console.log(channel);
                        divDataChannels.append(
                            $("<label><input type='checkbox' name='recordedChannels' value='" + channel + "' checked/>" + channel + "</label><br />")
                        );
                    });
                }
            });
            
        });
        $("#configure-recorder").click(function(){
            let channels = [];
            $('input[name="recordedChannels"]:checked').each(function(){
                channels.push($(this).val());
            });
            let path = null;

            if ($("#custom-telemetry-path").prop('checked')) {
                path = $("#telemetry-path").val();
            }            
            console.log(channels);
            $.ajax({
                type: "POST",
                url: "recorder_config", 
                data: JSON.stringify({
                    "channels": channels,
                    "path": path,
                }),
                success: function(data) {
                    channels = data['channels'];

                    //$("#data-channels").text(JSON.stringify(dataChannels));
                    divDataChannels = $('#data-channels');
                    /*
                    channels.forEach(function(channel) {
                        console.log(channel);
                        divDataChannels.append(
                            $("<label><input type='checkbox' name='recordedChannels' value='" + channel + "' checked/>" + channel + "</label><br />")
                        );
                    });
                    */
                }
            });
            
        });
    });
</script>
{% end %}
